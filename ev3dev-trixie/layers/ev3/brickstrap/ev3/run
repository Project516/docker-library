#!/bin/bash

set -e

# 1. HACK: Bypass flash-kernel for Docker Build
# ---------------------------------------------------------
if [ -f /usr/sbin/flash-kernel ]; then
    mv /usr/sbin/flash-kernel /usr/sbin/flash-kernel.real
fi

echo '#!/bin/sh' > /usr/sbin/flash-kernel
echo 'echo "Fake flash-kernel: Skipping hardware check for build."' >> /usr/sbin/flash-kernel
echo 'exit 0' >> /usr/sbin/flash-kernel
chmod +x /usr/sbin/flash-kernel

# 2. Setup Environment
# ---------------------------------------------------------
mkdir -p /boot/flash
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true

# 3. Update & Install ONLY Standard Debian Tools
# ---------------------------------------------------------
apt-get update

# WE REMOVED: ev3-config, ev3-systemd, zram-init, firmware-ti-connectivity
# WE KEPT: u-boot-tools, kmod, initramfs-tools (Standard Debian)
apt-get install --yes --no-install-recommends \
    u-boot-tools \
    kmod \
    initramfs-tools

# 4. Install Your Custom Kernel
# ---------------------------------------------------------
echo "Installing Custom Kernel..."
dpkg -i /tmp/*.deb || apt-get install -f -y

# 5. Post-Install Fixes
# ---------------------------------------------------------
# Fix SSH key permissions
chmod 600 /etc/ssh/ssh_host_*_key || true

# Set default font
echo -e -n "\nFONT='Lat15-TomThumb4x6.psf.gz'" >> /etc/default/console-setup
setupcon --save-only || true

# 6. U-Boot Setup
# ---------------------------------------------------------
u_boot_version="v2018.07-rc0-ev3dev2"
u_boot_url="https://github.com/ev3dev/u-boot/releases/download"
u_boot_files="boot.scr u-boot.bin uEnv.txt"

for f in $u_boot_files; do
    wget $u_boot_url/$u_boot_version/$f
done

for f in $u_boot_files; do
    mv $f /boot/flash/
done

# fstab fix
cat >> /etc/fstab << EOF
tmpfs           /run            tmpfs  nosuid,noexec,size=20M,nr_inodes=4096 0    0
EOF