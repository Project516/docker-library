#!/bin/bash

set -e

# 1. HACK: Bypass flash-kernel for Docker Build
# ---------------------------------------------------------
if [ -f /usr/sbin/flash-kernel ]; then
    mv /usr/sbin/flash-kernel /usr/sbin/flash-kernel.real
fi

echo '#!/bin/sh' > /usr/sbin/flash-kernel
echo 'echo "Fake flash-kernel: Skipping hardware check for build."' >> /usr/sbin/flash-kernel
echo 'exit 0' >> /usr/sbin/flash-kernel
chmod +x /usr/sbin/flash-kernel

# 2. Setup Environment
# ---------------------------------------------------------
mkdir -p /boot/flash
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true

# 3. Update & Install ONLY Standard Debian Tools
# ---------------------------------------------------------
apt-get update

# WE REMOVED: ev3-config, ev3-systemd, zram-init, firmware-ti-connectivity
# WE KEPT: u-boot-tools, kmod, initramfs-tools (Standard Debian)
apt-get install --yes --no-install-recommends \
    u-boot-tools \
    kmod \
    initramfs-tools

# 4. Install Custom Kernel & Fix Bootloader (GLUE FIX)
# ---------------------------------------------------------
echo "Installing Custom Kernel..."
dpkg -i /tmp/*.deb || apt-get install -f -y

echo "Gluing Kernel and DTB for legacy EV3 bootloader..."
# 1. Find the kernel we just installed (sort by version to get the latest)
KERNEL_FILE=$(ls -v /boot/vmlinuz* | tail -n 1)
# 2. Find the DTB file (It hides in /usr/lib/...)
DTB_FILE=$(find /usr -name "da850-lego-ev3.dtb" | head -n 1)

if [ -f "$KERNEL_FILE" ] && [ -f "$DTB_FILE" ]; then
    echo "Found Kernel: $KERNEL_FILE"
    echo "Found DTB: $DTB_FILE"

    # 3. Concatenate (Kernel + DTB) -> zImage
    cat "$KERNEL_FILE" "$DTB_FILE" > /boot/zImage-dtb

    # 4. Generate uImage (The one that actually boots)
    mkimage -A arm -O linux -T kernel -C none -a 0xc0008000 -e 0xc0008000 \
      -n "Linux 6.12 w/DTB" -d /boot/zImage-dtb /boot/uImage

    # 5. Copy DTB to /boot (Just in case we need it separately later)
    cp "$DTB_FILE" /boot/da850-lego-ev3.dtb

    # 6. Cleanup
    rm /boot/zImage-dtb
    echo "SUCCESS: uImage created with appended DTB."
else
    echo "ERROR: Could not find kernel or DTB. Boot image will be broken."
    exit 1
fi

# 5. Post-Install Fixes
# ---------------------------------------------------------
# Fix SSH key permissions
chmod 600 /etc/ssh/ssh_host_*_key || true

# Set default font
echo -e -n "\nFONT='Lat15-TomThumb4x6.psf.gz'" >> /etc/default/console-setup
setupcon --save-only || true

# 6. U-Boot Setup
# ---------------------------------------------------------
u_boot_version="v2018.07-rc0-ev3dev2"
u_boot_url="https://github.com/ev3dev/u-boot/releases/download"
u_boot_files="boot.scr u-boot.bin uEnv.txt"

for f in $u_boot_files; do
    wget $u_boot_url/$u_boot_version/$f
done

for f in $u_boot_files; do
    mv $f /boot/flash/
done

# fstab fix
cat >> /etc/fstab << EOF
tmpfs           /run            tmpfs  nosuid,noexec,size=20M,nr_inodes=4096 0    0
EOF